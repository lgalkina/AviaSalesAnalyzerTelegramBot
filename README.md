# Описание того, что же тут происходит

Телеграм в Desktop'ной версии без VPN не работает. Поэтому запускать вашего бота можно или через VPN или через proxy.
Например можно попытаться посмотреть описание [тут](https://tlgrm.ru/faq/obhod-blokirovki-telegram.html.)

В файле [2020_DPO_11_0_bot](https://github.com/pileyan/DPO_Python_2020/blob/master/11_Bot/2020_DPO_11_0_bot.ipynb) описан и сделан парсер сайта worldometers. На выходе с помощью вызова функции stat() создается Pandas-dataframe со статистикой по коронавирусу. Аргумент tag = 0 (сегодня) и tag = 1 (вчера) управляет выбором дня, за который собирается статистика.
## Что делает бот?
Когда пользователь запрашивает информацию (задает день, регионы или страны и набор полей, который он хочет просмотреть, бот должен отдавать ему информацию в табличном формате (tabulate в помощь - см.[тут](https://github.com/pileyan/DPO_Python_2020/blob/master/11_Bot/2020_DPO_11_0_bot.ipynb). У бота не должно быть "непонятых команд" - на каждое сообщение у бота есть ответ. Кроме того, если пользователь прекратил диалог с ботом на середине (например, ввел список стран, но не определил день статистики, в следующий раз бот напомнит ему о том, что надо выбрать, страны или регионы.

### Как зарегистрировать нового бота:
Читать [тут](https://tlgrm.ru/docs/bots) или [тут](https://habr.com/en/post/262247/)

## Теперь пройдемся по файлам бота по порядку и разберем, что же в нем происходит
### Файл [config](https://github.com/pileyan/DPO_Python_2020/blob/master/11_Bot/config.py) 
содержит некоторые внутренние характеристики бота (название базы данных - потом посмотрим, зачем это нужно) телеграм-токен этого бота и список возможных статусов, которые упакованы в класс States (Это упорядоченная последовательность уровней взаимодействия с ботом: 
* Старт диалога
* Ввод дня (вчера или сегодня)
* Выбор стран или регионов (в dataframe, как вы помните, лежит и то и другое)
* Выбор списка стран/списка регионов, по которым будет отображена статистика
* Выбор полей, которые хочется увидеть (TotalCases, NewCases и т.д. Все названия достаточно говорящие)

Про Enum есть в [тут](https://pynsk.ru/blog/2016/02/13/enum/)

### Файл [database.vdb](https://github.com/pileyan/DPO_Python_2020/blob/master/11_Bot/database.vdb)

Это база данных Vedis (ключ-значение, похоже на словарь), где храниться информация о последнем статусе пользователя. Ключ здесь - id пользователя(message.chat.id), а значение - его статус. Раз уж почти что словарь, можно туда записать и состояние выбранных человеком параметров (например, человек выбрал статистику за вчерашний день и мы не хотим его постоянно переспрашивать). Записать это в базу можно костылем ( ключ - message.chat.id+имя характеристики, а значение - значение характеристики). 

Документация [Vedis](https://vedis-python.readthedocs.io/en/latest/)

### Файл [dbworker.py](https://github.com/pileyan/DPO_Python_2020/blob/master/11_Bot/dbworker.py)
Здесь лежат функции для чтения и записи состояний в базу (работает почти как для словаря)
Дополнительно я завел отдельную функцию для записи характеристик в базу(она 1 в 1 такая же, как и для записи состояния, но ее в последствии ее можно будет чуть модифицировать)

### Файл [main.py](https://github.com/pileyan/DPO_Python_2020/blob/master/11_Bot/main.py)

Тут описан сам бот.
Он использует библиотеку telebot. Внутри бота несколько функций, запускающихся после @message handler'a (это как обычный декоратор)

Каждая из функций вызывается командой(прописана в аргументе декоратора):
#### cmd_start - приветствие (запускется при команде /start)
Выдает приветственное сообщение со списком команд и отправляет случайную картиночку(одну из массива pict, который я любезно предварительно созхранил, минуту поискав картинки по запросу "вирус")
После выполнения команда меняет состояние пользователя на "ввод дня"

#### cmd_reset - сброс состояния (запускется при команде /reset)

Сбрасывает состояние пользователя до ввода дня (позволяет изменить свой запрос и начать заново)

#### cmd_info - описание бота (запускется при команде /info)

Рассказывает, что бот делает (много текста)

#### cmd_commands - описание списка команд (запускется при команде /commands)

Выводит на печать набор доступных функций в боте

#### cmd_listregions и cmd_listcountries - вывод списка регионов/стран (запускются при командах /listregions и /listcountries)

Достают список доступных регионов/доступных стран в статистике (под капотом запускают парсер)

#### get_day - запрос дня (запускется, если состояние пользователя в базе - запрос дня и запрос не содержит иных команд, например - информационных)







